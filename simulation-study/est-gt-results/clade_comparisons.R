library(ggplot2)
library(ggtree)
library(tidyverse)
library(awtools)

# 1. Only take major trees and set all edge lengths to -1.
est <- treeio::read.tree(text="(OUTGROUP,(((((((((t101,t102),((t105,((t107,t108),(t113,t114))),(t109,(t111,t112)))),(t103,((t104,(t106,((t110,(t116,t117)),(t124,t125)))),((t118,(t122,t123)),t119)))),(t115,(t120,t121))),(t126,(((t127,((((t130,(t141,t142)),(t133,(t140,(t149,t150)))),(t138,(t139,(t145,t146)))),(t131,((t134,t135),(t147,t148))))),(t132,(t143,t144))),((t128,t129),(t136,t137))))),((((((t26,(t27,(t39,t40))),(t33,t34)),t32),((t28,(t30,t31)),(t41,t42))),((t29,(t38,(t45,t46))),((t36,t37),(t44,(t49,t50))))),(t35,(t43,(t47,t48))))),((((t276,((t278,(t279,t280)),((t282,(t289,(t291,t292))),(t293,t294)))),(t277,(t283,(t284,t285)))),((((t281,(t286,(t287,t288))),(t295,t296)),(t290,(t297,t298))),(t299,t300))),((((t301,((t319,(t324,t325)),t322)),((t309,t310),(t314,t323))),((t302,(t303,(t304,((t311,(t317,t318)),(t312,t313))))),(((t305,t306),(t315,t316)),(t307,t308)))),(t320,t321)))),(((((((t451,(t452,((t459,(t462,t463)),(t467,t468)))),(t453,(t464,(t472,t473)))),((t455,t456),((t460,t461),(t465,t466)))),((t469,t471),t470)),((t454,(t457,t458)),(t474,t475))),((((((((t476,((t478,t479),(((t481,((t485,t486),(t488,t489))),((t487,(t499,t500)),(t497,t498))),(t483,t484)))),(t480,(t495,t496))),t477),(t491,t492)),t482),t490),t494),t493)),(((t51,(t74,t75)),(((((t52,t53),(t54,(t70,t71))),(t55,t56)),(((t58,t59),(t61,(t68,t69))),t63)),((t57,t62),((t60,(t72,t73)),(t64,t65))))),(t66,t67)))),((((t351,(t354,(((t368,t370),t369),((t371,t372),t373)))),((t352,(t353,(t357,t358))),((t355,((t356,(t364,t365)),(t359,t360))),(((t361,t374),(t362,(t363,(t366,t367)))),t375)))),((t376,(t377,((t379,(t380,t381)),(((t382,(t385,t386)),(t387,t388)),((t392,t393),(t395,t396)))))),((t383,t384),((t394,(t399,t400)),t390)))),((t389,t391),(t378,(t398,(t397,(((((t1,(t12,(((t14,t15),t7),t2))),(((((t10,t11),(t8,t9)),((t16,(t21,(t24,t25))),t6)),(t13,(t17,(t19,t20)))),((t18,(t22,t23)),t5))),(t3,t4)),((((t226,(((((t234,(t249,t250)),(t238,t239)),(t245,t246)),(t247,t248)),(t236,t237))),((t227,(t228,(t230,t231))),((t229,((t233,t235),(t243,t244))),(t241,t242)))),(t232,t240)),(((((t251,((((t252,((t268,t269),(t270,t271))),(((t255,(t262,t263)),t256),(t259,(t266,(t272,t273))))),(t253,(t254,(t260,(t264,t265))))),(t257,t258))),t261),t267),t275),t274))),((((((((t100,t99),t88),(t86,t87)),(t97,t98)),t77),(((t78,t79),((((t82,(t90,t91)),(t83,t84)),t95),(t85,(t92,t93)))),(((t80,t81),(t89,t94)),t96))),t76),(((((t151,t155),(t162,t163)),((t160,t161),(t167,t168))),((((t152,((t164,(((t169,t170),t171),(t174,t175))),(t172,t173))),(((t153,t154),t156),(t165,t166))),t157),(t158,t159))),(((((t176,(t183,(t184,(t187,t188)))),((t180,t181),((t191,t192),(t195,t196)))),((t177,(t179,((t182,(t197,t198)),((t185,(t189,t190)),(t199,t200))))),t186)),(t178,(t193,t194))),(((((((((t201,(((((t202,t203),(t215,t216)),(t206,(t210,t211))),(t224,t225)),((t208,t209),(t212,t213)))),(t217,t218)),(t207,(t214,(t219,t220)))),t204),t205),t221),t223),t222),((((t326,((((t329,(t334,(t341,t342))),((t333,(t349,t350)),((t336,t337),t338))),((t330,(t331,t332)),(t343,t344))),((t335,(t345,t346)),(t339,(t340,(t347,t348)))))),t328),t327),((t401,((((t402,(t403,(t404,(((t412,t413),(t418,t419)),(t422,t423))))),(t411,(t420,t421))),((t409,t410),((t414,t415),(t424,t425)))),((t405,t406),(t407,(t408,(t416,t417)))))),(t426,(t427,((t447,t448),(((t432,t433),(t443,t444)),(((t429,(t430,t431)),((t436,(t439,t440)),((t437,t438),(t445,t446)))),((t449,t450),((t434,t435),(t428,(t442,t441)))))))))))))))))))))));")

tru <- treeio::read.tree(text="(((((((t3,t4),(((((t22,t23),t18),t5),(((t13,(t17,(t19,t20))),t12),(((t8,t9),(t10,t11)),(t6,(t16,((t24,t25),t21)))))),((t2,(t7,(t14,t15))),t1))),(((((((t233,(t235,(t241,t242))),(t243,t244)),t229),(t227,(t228,(t230,t231)))),((t226,((t247,t248),(((t239,t238),((t249,t250),t234)),(t245,t246)))),(t236,t237))),(t232,t240)),(((t257,t258),(((t267,(t274,t275)),t261),t251)),((t253,(((t264,t265),t260),t254)),((((t266,(t272,t273)),t259),(t255,((t262,t263),t256))),(t252,((t268,t269),(t270,t271)))))))),((t76,(((((t92,t93),t85),((((t90,t91),t82),(t83,t84)),t95)),(t78,t79)),((((((t99,t100),t88),(t86,t87)),(t97,t98)),t77),(((t94,t96),t89),(t80,t81))))),(((((t160,t161),(t167,t168)),((t162,t163),(t151,t155))),((t158,t159),((((t153,t154),(t156,t157)),(t165,t166)),(((((t174,t175),((t170,t171),t169)),t164),(t172,t173)),t152)))),(((((((t195,t196),(t191,t192)),(t180,t181)),((((t187,t188),t184),t183),t176)),(t177,(((t199,t200),(t185,(t189,t190))),((t179,t186),((t197,t198),t182))))),(t178,(t193,t194))),((((t401,(((t407,(t408,(t416,t417))),(t405,t406)),((((t420,t421),t411),(t402,(t403,((((t412,t413),(t418,t419)),(t422,t423)),t404)))),(((t424,t425),(t414,t415)),(t409,t410))))),((((t447,t448),((((t449,t450),((t434,t435),((t441,t442),t428))),(((t430,t431),t429),(((t445,t446),(t437,t438)),((t439,t440),t436)))),((t432,t433),(t443,t444)))),t427),t426)),((t326,(t327,t328)),(((t339,((t347,t348),t340)),(t335,(t345,t346))),((((t331,t332),t330),(t343,t344)),((t329,((t341,t342),t334)),(((t337,t338),t336),((t349,t350),t333))))))),((((t217,t218),(((t204,t205),(t221,(t222,t223))),((t214,(t219,t220)),t207))),t201),(((t224,t225),((t206,(t210,t211)),((t215,t216),(t202,t203)))),((t212,t213),(t208,t209))))))))),(((((((t359,t360),(t356,(t364,t365))),t355),((((t366,t367),t363),t362),(t361,(t374,t375)))),((t353,(t357,t358)),t352)),(((((t371,t372),t373),((t370,t369),t368)),t354),t351)),(((t389,t391),(t378,(t397,t398))),(((t383,t384),((t394,(t399,t400)),t390)),((((t379,(t380,t381)),(t376,t377)),((t387,t388),(t382,(t385,t386)))),((t395,t396),(t392,t393))))))),((((t66,t67),(((t74,t75),t51),((((t55,t56),(((t70,t71),t54),(t52,t53))),((t58,t59),((t61,t63),(t68,t69)))),((t57,t62),((t64,t65),((t72,t73),t60)))))),((((t469,(t470,t471)),((((t465,t466),(t460,t461)),(t455,t456)),(((((t467,t468),(t459,(t462,t463))),t452),t451),(((t472,t473),t464),t453)))),((t474,t475),((t457,t458),t454))),(((t483,t484),((((t477,((t482,(t490,(t493,t494))),(t491,t492))),((t495,t496),t480)),t476),(t478,t479))),((t481,((t488,t489),(t485,t486))),(((t499,t500),t487),(t497,t498)))))),(((((t29,(((t45,t46),t38),((t44,(t49,t50)),(t36,t37)))),(((t28,(t30,t31)),(t41,t42)),((t33,t34),(((t27,(t39,t40)),t26),t32)))),((t43,(t47,t48)),t35)),((((t120,t121),t115),(((t101,t102),(((t111,t112),t109),(((t113,t114),(t107,t108)),t105))),((((t118,t119),(t122,t123)),(t104,(((t110,(t116,t117)),(t124,t125)),t106))),t103))),(t126,((((t131,((t134,t135),(t147,t148))),(((t139,(t145,t146)),t138),((((t149,t150),t140),t133),(((t142,t141),(t132,(t143,t144))),t130)))),t127),((t136,t137),(t128,t129)))))),(((((((t282,(t289,(t291,t292))),(t293,t294)),((t279,t280),t278)),t276),(((t284,t285),t283),t277)),((t299,t300),(((t281,((t287,t288),t286)),(t295,t296)),(t290,(t297,t298))))),((((t301,((t319,t322),(t324,t325))),((t309,t310),(t314,t323))),(((t307,t308),((t305,t306),(t315,t316))),((t303,(((t311,(t317,t318)),(t312,t313)),t304)),t302))),(t320,t321)))))),OUTGROUP);")

ntaxa <- 500
clade_size <- 25

tip_categories <- tibble(
    tip_name = c(paste0("t", 1:ntaxa), "OUTGROUP"),
    clade_number = c(((1:ntaxa - 1) %/% clade_size), "OUTGROUP")
)

plot_colored_tree <- function(tre, title = "", hilight_nodes=c(1), hflip=FALSE) {
    # Find the MRCA node number for each clade
    mrcas <- c()
    for(clade_num in unique(tip_categories$clade_number)) {
        temp_names <- tip_categories$tip_name[tip_categories$clade_number == clade_num]
        if(length(temp_names) == 1) { next } # outgroup

        temp_mrca <- temp_names[1]
        for(i in 2:length(temp_names)) {
            mm <- MRCA(tre, temp_names[1], temp_names[i])
            if(length(mm) == 0) { next }
            temp_mrca <- min(temp_mrca, mm)
        }
        mrcas <- c(mrcas, temp_mrca)
    }
    mrcas <- as.integer(mrcas)
    names(mrcas) <- 1:(ntaxa / clade_size)
    tre <- groupClade(tre, mrcas)

    # Plot stuff
    colors <- rainbow(length(mrcas))
    p <- ggtree(tre, aes(color = group)) %<+% tip_categories +
        geom_tiplab(
            color = "black",
            geom = "label",
            label.padding = unit(0.15, "lines"),
            label.size = 0) +
        scale_color_manual(values = c("black", colors))
    
    for(i in 1:length(mrcas)) {
        p <- p +
            geom_hilight(
                node=as.integer(mrcas[i]), alpha = 0.4,
                color = colors[i], fill = colors[i],
                type = "roundrect"
            )
    }
    p <- p & guides(color = "none")
    
    p
}

plot_colored_tree(tru, title = "True major tree", hflip=TRUE)
plot_colored_tree(est, title = "Estimated major tree")


# 2. Save as PDF
# 3. Add lines in Krita
# 4. Add reticulations in Krita
pdf(file = "/mnt/dv/wid/projects4/SolisLemus-network-merging/simulation-study/est-gt-results/tru_clade_comparison.pdf", width=18, height=40)
plot_colored_tree(tru, title = "True major tree")
dev.off()

pdf(file = "/mnt/dv/wid/projects4/SolisLemus-network-merging/simulation-study/est-gt-results/est_clade_comparison.pdf", width=18, height=40)
plot_colored_tree(est, title = "Estimated major tree")
dev.off()



# BOOK: https://yulab-smu.top/treedata-book/chapter5.html
# Line coloring from this plot may also be preferable: https://yulab-smu.top/treedata-book/chapter13.html#hpv58